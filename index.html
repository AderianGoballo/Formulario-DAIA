<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento Atletas UCV - Artículo 25</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and app state
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.userId = null;
        window.isAuthReady = false;
        window.currentView = 'disciplines'; // 'disciplines', 'athletes', 'questionnaire', 'admin'
        window.selectedDiscipline = null;
        window.selectedAthlete = null;
        window.isAdmin = false;
        window.showPasswordPrompt = false;
        window.passwordError = '';
        window.ADMIN_PASSWORD = '7#pL9@xQ$2!zMnB&';
        window.message = ''; // Global message for user feedback

        // Google Sheet URL
        window.GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1aw2H5AQ5GQ_QT1UhG4jEDECKQAVXtbVw0t4eT-z91MY/edit#gid=0";
        window.GOOGLE_APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbybMauVy1_rVK7yRRQQ9L0X4ZxS9cISOOSkp1oJ-1xtmyEPBBhYTx9NnNHKQPgWH1A/exec";

        // Initialize Firebase when the window loads
        window.addEventListener('load', async () => {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Authenticate user
            try {
                if (window.initialAuthToken) {
                    await signInWithCustomToken(window.auth, window.initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Error signing in:", error);
                await signInAnonymously(window.auth); // Fallback
            }

            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                } else {
                    window.userId = crypto.randomUUID();
                }
                window.isAuthReady = true;
                console.log("Firebase Auth Ready. User ID:", window.userId);
                renderApp(); // Initial render after auth is ready
                seedData(); // Seed data if needed
            });
        });

        // Background Images for Carousel
        window.backgroundImages = [
            "https://placehold.co/1920x1080/ADD8E6/000000?text=Piscina+UCV",
            "https://placehold.co/1920x1080/ADD8E6/000000?text=Cancha+Atletismo+UCV",
            "https://placehold.co/1920x1080/ADD8E6/000000?text=Estadio+Beisbol+UCV",
            "https://placehold.co/1920x1080/ADD8E6/000000?text=Gimnasio+UCV",
            "https://placehold.co/1920x1080/ADD8E6/000000?text=Cancha+Multiple+UCV"
        ];
        window.currentImageIndex = 0;

        // List of disciplines to pre-populate
        window.defaultDisciplines = [
            "Club de Ajedrez", "Club de Atletismo", "Club de Baloncesto", "Club de Beisbol",
            "Club de Boxeo", "Natación", "Polo Acuático", "Submarinismo", "Club de Esgrima",
            "Club de Excursionismo", "Club de Fútbol", "Club de Fútbol Sala", "Club de Gimnasia Rítmica",
            "Club de Judo", "Club de Karate-Do (Shito Ryu Sosei Kay)", "Club de Karate Libre",
            "Club de Kenpo", "Club de Kickingball", "Club de Kung-Fu Mantis", "Club de Kung-Fu Pajoj Pai",
            "Club de Levantamiento de Pesas", "Club de Lucha", "Club de Rugby", "Club de Salto Ornamental",
            "Club de Softbol", "Club de Taekwondo", "Club de Tenis", "Club de Tenis de Mesa",
            "Club de Voleibol", "Club de Voleibol Arena", "Club de Yoga"
        ];

        // Function to seed initial data
        async function seedData() {
            if (!window.isAuthReady || !window.db) return;

            const disciplinesCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/disciplines`);
            const athletesCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/athletes`);

            try {
                const disciplinesSnapshot = await getDocs(disciplinesCollectionRef);

                if (disciplinesSnapshot.empty) {
                    console.log("Seeding initial data: Disciplines and Athletes...");
                    for (const disciplineName of window.defaultDisciplines) {
                        const newDisciplineRef = await addDoc(disciplinesCollectionRef, { name: disciplineName });
                        for (let i = 1; i <= 5; i++) {
                            await addDoc(athletesCollectionRef, {
                                name: `Atleta ${i} - ${disciplineName}`,
                                disciplineId: newDisciplineRef.id,
                                questionnaireData: {}
                            });
                        }
                    }
                    console.log("Initial data seeding complete.");
                    renderApp(); // Re-render after seeding
                } else {
                    console.log("Database already contains data. Skipping seeding.");
                }
            } catch (error) {
                console.error("Error seeding initial data:", error);
            }
        }

        // Function to navigate between views
        window.navigateTo = (newView, discipline = null, athlete = null) => {
            window.currentView = newView;
            window.selectedDiscipline = discipline;
            window.selectedAthlete = athlete;
            renderApp(); // Re-render the app when view changes
        };

        // Function to display messages
        window.displayMessage = (msg, isError = false) => {
            window.message = msg;
            const messageDiv = document.getElementById('app-message');
            if (messageDiv) {
                messageDiv.className = `mb-4 p-3 rounded-lg text-center ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                messageDiv.textContent = msg;
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                    window.message = '';
                }, 5000); // Hide message after 5 seconds
            }
        };

        // Render functions for each view
        function renderDisciplineList() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            mainContent.innerHTML = `
                <div class="p-4">
                    <h2 class="text-2xl font-semibold text-blue-700 mb-6 text-center">Seleccione una Disciplina</h2>
                    <div id="disciplines-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-center text-blue-600" id="loading-disciplines">Cargando disciplinas...</div>
                    </div>
                </div>
            `;

            const disciplinesGrid = document.getElementById('disciplines-grid');

            if (!window.isAuthReady || !window.db) {
                disciplinesGrid.innerHTML = `<div class="text-center text-red-600">Autenticación no lista.</div>`;
                return;
            }

            const disciplinesCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/disciplines`);
            onSnapshot(disciplinesCollectionRef,
                (snapshot) => {
                    const fetchedDisciplines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    disciplinesGrid.innerHTML = ''; // Clear loading message
                    if (fetchedDisciplines.length === 0) {
                        disciplinesGrid.innerHTML = `<div class="text-center text-gray-600 col-span-full">No hay disciplinas disponibles.</div>`;
                    } else {
                        fetchedDisciplines.forEach(discipline => {
                            const button = document.createElement('button');
                            button.className = "p-4 bg-blue-100 rounded-lg shadow-md hover:bg-blue-200 transition-colors duration-200 text-blue-800 font-medium text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 border border-blue-300";
                            button.textContent = discipline.name;
                            button.onclick = () => window.navigateTo('athletes', discipline);
                            disciplinesGrid.appendChild(button);
                        });
                    }
                },
                (err) => {
                    console.error("Error fetching disciplines:", err);
                    disciplinesGrid.innerHTML = `<div class="text-center text-red-600 col-span-full">Error al cargar disciplinas. Por favor, intente de nuevo.</div>`;
                }
            );
        }

        function renderAthleteList() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            if (!window.selectedDiscipline) {
                mainContent.innerHTML = `<div class="text-center text-red-600">No se ha seleccionado ninguna disciplina.</div>`;
                return;
            }

            mainContent.innerHTML = `
                <div class="p-4">
                    <h2 class="text-2xl font-semibold text-blue-700 mb-6 text-center">Atletas de ${window.selectedDiscipline.name}</h2>
                    <div id="athletes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-center text-blue-600" id="loading-athletes">Cargando atletas...</div>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="back-to-disciplines" class="px-6 py-3 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            Volver a Disciplinas
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('back-to-disciplines').onclick = () => window.navigateTo('disciplines');
            const athletesGrid = document.getElementById('athletes-grid');

            if (!window.isAuthReady || !window.db) {
                athletesGrid.innerHTML = `<div class="text-center text-red-600">Autenticación no lista.</div>`;
                return;
            }

            const athletesCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/athletes`);
            const q = query(athletesCollectionRef, where("disciplineId", "==", window.selectedDiscipline.id));

            onSnapshot(q,
                (snapshot) => {
                    const fetchedAthletes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    athletesGrid.innerHTML = ''; // Clear loading message
                    if (fetchedAthletes.length === 0) {
                        athletesGrid.innerHTML = `<div class="text-center text-gray-600 col-span-full">No hay atletas registrados para ${window.selectedDiscipline.name}.</div>`;
                    } else {
                        fetchedAthletes.forEach(athlete => {
                            const button = document.createElement('button');
                            button.className = "p-4 bg-blue-100 rounded-lg shadow-md hover:bg-blue-200 transition-colors duration-200 text-blue-800 font-medium text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 border border-blue-300";
                            button.textContent = athlete.name;
                            button.onclick = () => window.navigateTo('questionnaire', window.selectedDiscipline, athlete);
                            athletesGrid.appendChild(button);
                        });
                    }
                },
                (err) => {
                    console.error("Error fetching athletes:", err);
                    athletesGrid.innerHTML = `<div class="text-center text-red-600 col-span-full">Error al cargar atletas. Por favor, intente de nuevo.</div>`;
                }
            );
        }

        function renderQuestionnaire() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            if (!window.selectedAthlete || !window.selectedDiscipline) {
                mainContent.innerHTML = `<div class="text-center text-red-600">No se ha seleccionado ningún atleta para el cuestionario.</div>`;
                return;
            }

            const athlete = window.selectedAthlete;
            const discipline = window.selectedDiscipline;
            const questionnaireData = athlete.questionnaireData || {};

            mainContent.innerHTML = `
                <div class="p-4">
                    <h2 class="text-2xl font-semibold text-blue-700 mb-6 text-center">
                        Cuestionario de Seguimiento para ${athlete.name} (${discipline.name})
                    </h2>
                    <form id="questionnaire-form" class="space-y-4 bg-blue-50 p-6 rounded-lg shadow-inner border border-blue-200">
                        <div>
                            <label htmlFor="performanceRating" class="block text-blue-700 text-lg font-medium mb-2">
                                Rendimiento Deportivo:
                            </label>
                            <select
                                id="performanceRating"
                                class="w-full p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                required
                            >
                                <option value="">Seleccione una opción</option>
                                <option value="Excelente">Excelente</option>
                                <option value="Bueno">Bueno</option>
                                <option value="Regular">Regular</option>
                                <option value="Necesita Mejorar">Necesita Mejorar</option>
                            </select>
                        </div>
                        <div>
                            <label htmlFor="academicStatus" class="block text-blue-700 text-lg font-medium mb-2">
                                Estatus Académico:
                            </label>
                            <select
                                id="academicStatus"
                                class="w-full p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                required
                            >
                                <option value="">Seleccione una opción</option>
                                <option value="Activo y al día">Activo y al día</option>
                                <option value="Bajo rendimiento">Bajo rendimiento</option>
                                <option value="Retirado temporalmente">Retirado temporalmente</option>
                                <option value="Retirado definitivamente">Retirado definitivamente</option>
                            </select>
                        </div>
                        <div>
                            <label htmlFor="comments" class="block text-blue-700 text-lg font-medium mb-2">
                                Comentarios Adicionales:
                            </label>
                            <textarea
                                id="comments"
                                rows="5"
                                class="w-full p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                placeholder="Escriba aquí sus observaciones..."
                            ></textarea>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button
                                type="submit"
                                id="submit-questionnaire"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Enviar Cuestionario
                            </button>
                            <button
                                type="button"
                                id="cancel-questionnaire"
                                class="px-6 py-3 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50"
                            >
                                Cancelar
                            </button>
                        </div>
                        <div id="questionnaire-message" class="mt-4 p-3 rounded-lg text-center" style="display: none;"></div>
                    </form>
                </div>
            `;

            // Pre-fill form if data exists
            document.getElementById('performanceRating').value = questionnaireData.performanceRating || '';
            document.getElementById('academicStatus').value = questionnaireData.academicStatus || '';
            document.getElementById('comments').value = questionnaireData.comments || '';

            const questionnaireMessageDiv = document.getElementById('questionnaire-message');
            if (window.message) {
                questionnaireMessageDiv.textContent = window.message;
                questionnaireMessageDiv.className = `mt-4 p-3 rounded-lg text-center ${window.message.includes('Error') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                questionnaireMessageDiv.style.display = 'block';
            }

            document.getElementById('questionnaire-form').onsubmit = async (e) => {
                e.preventDefault();
                const submitButton = document.getElementById('submit-questionnaire');
                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';
                questionnaireMessageDiv.style.display = 'none';
                window.message = '';

                const data = {
                    timestamp: new Date().toISOString(),
                    athleteName: athlete.name,
                    disciplineName: discipline.name,
                    performanceRating: document.getElementById('performanceRating').value,
                    academicStatus: document.getElementById('academicStatus').value,
                    comments: document.getElementById('comments').value,
                    athleteId: athlete.id,
                    disciplineId: discipline.id,
                };

                try {
                    // Update athlete's document in Firestore
                    const athleteDocRef = doc(window.db, `artifacts/${window.appId}/public/data/athletes`, athlete.id);
                    await updateDoc(athleteDocRef, {
                        questionnaireData: data
                    });
                    window.displayMessage("Datos del cuestionario guardados en Firestore.");

                    // Send to Google Sheet
                    await submitToGoogleSheet(data);

                    setTimeout(() => {
                        window.navigateTo('athletes', discipline);
                    }, 2000);

                } catch (error) {
                    console.error("Error submitting questionnaire:", error);
                    window.displayMessage(`Error al enviar el cuestionario. Detalles: ${error.message}`, true);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar Cuestionario';
                }
            };

            document.getElementById('cancel-questionnaire').onclick = () => window.navigateTo('athletes', discipline);
        }

        async function submitToGoogleSheet(data) {
            if (!window.GOOGLE_APPS_SCRIPT_WEB_APP_URL || window.GOOGLE_APPS_SCRIPT_WEB_APP_URL.includes("YOUR_DEPLOYED_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE")) {
                window.displayMessage("Error: La URL de Google Apps Script no ha sido configurada correctamente. Por favor, verifica el script.", true);
                console.error("Google Apps Script URL is not configured or is a placeholder.");
                return;
            }

            try {
                const response = await fetch(window.GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                if (result.status === 'success') {
                    window.displayMessage("Cuestionario enviado a Google Sheet correctamente.");
                } else {
                    console.error("Error from Google Apps Script:", result.message);
                    window.displayMessage(`Error al enviar datos a Google Sheet: ${result.message}`, true);
                }
            } catch (error) {
                console.error("Error sending data to Google Sheet:", error);
                window.displayMessage(`Error al enviar datos a Google Sheet. Intente de nuevo. Esto puede deberse a un problema de red o a que el Google Apps Script no está configurado para aceptar solicitudes desde esta aplicación. Detalles: ${error.message}`, true);
            }
        }

        function renderAdminPanel() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            mainContent.innerHTML = `
                <div class="p-4">
                    <h2 class="text-2xl font-semibold text-blue-700 mb-6 text-center">Panel de Administración</h2>

                    <div id="admin-message" class="mb-4 p-3 rounded-lg text-center" style="display: none;"></div>

                    <!-- Gestionar Disciplinas -->
                    <div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner border border-blue-200">
                        <h3 class="text-xl font-semibold text-blue-700 mb-4">Gestionar Disciplinas</h3>
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <input
                                type="text"
                                id="new-discipline-name"
                                placeholder="Nombre de la nueva disciplina"
                                class="flex-grow p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                            />
                            <button
                                id="add-discipline-btn"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                            >
                                Agregar Disciplina
                            </button>
                        </div>
                        <div id="disciplines-admin-list" class="space-y-3">
                            <!-- Disciplines will be loaded here -->
                        </div>
                    </div>

                    <!-- Gestionar Atletas -->
                    <div class="p-6 bg-blue-50 rounded-lg shadow-inner border border-blue-200">
                        <h3 class="text-xl font-semibold text-blue-700 mb-4">Gestionar Atletas</h3>
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <input
                                type="text"
                                id="new-athlete-name"
                                placeholder="Nombre del nuevo atleta"
                                class="flex-grow p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                            />
                            <select
                                id="new-athlete-discipline-select"
                                class="p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                            >
                                <!-- Discipline options will be loaded here -->
                            </select>
                            <button
                                id="add-athlete-btn"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                            >
                                Agregar Atleta
                            </button>
                        </div>
                        <div id="athletes-admin-list" class="space-y-3">
                            <!-- Athletes will be loaded here -->
                        </div>
                    </div>
                </div>
            `;

            const adminMessageDiv = document.getElementById('admin-message');
            if (window.message) {
                adminMessageDiv.textContent = window.message;
                adminMessageDiv.className = `mb-4 p-3 rounded-lg text-center ${window.message.includes('Error') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                adminMessageDiv.style.display = 'block';
            }

            // Admin Logic
            const disciplinesCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/disciplines`);
            const athletesCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/athletes`);

            let currentDisciplines = [];
            let currentAthletes = [];

            const renderAdminDisciplines = () => {
                const listDiv = document.getElementById('disciplines-admin-list');
                listDiv.innerHTML = '';
                currentDisciplines.forEach(discipline => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = "flex flex-col sm:flex-row items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-blue-100";
                    itemDiv.innerHTML = `
                        <span class="text-blue-800 font-medium flex-grow mb-2 sm:mb-0">${discipline.name}</span>
                        <div class="flex space-x-2">
                            <button class="edit-discipline-btn px-4 py-2 bg-blue-500 text-white rounded-lg shadow-sm hover:bg-blue-600 transition-colors duration-200 text-sm">Editar</button>
                            <button class="delete-discipline-btn px-4 py-2 bg-red-500 text-white rounded-lg shadow-sm hover:bg-red-600 transition-colors duration-200 text-sm">Eliminar</button>
                        </div>
                    `;
                    listDiv.appendChild(itemDiv);

                    itemDiv.querySelector('.edit-discipline-btn').onclick = () => {
                        const newName = prompt("Editar nombre de la disciplina:", discipline.name);
                        if (newName && newName.trim() !== '') {
                            updateDoc(doc(window.db, `artifacts/${window.appId}/public/data/disciplines`, discipline.id), { name: newName.trim() })
                                .then(() => window.displayMessage('Disciplina actualizada exitosamente.'))
                                .catch(e => { console.error("Error updating discipline: ", e); window.displayMessage('Error al actualizar disciplina.', true); });
                        }
                    };
                    itemDiv.querySelector('.delete-discipline-btn').onclick = () => {
                        if (confirm('¿Está seguro de que desea eliminar esta disciplina? Esto también eliminará a todos los atletas asociados.')) {
                            // Delete associated athletes first
                            const athletesToDelete = currentAthletes.filter(athlete => athlete.disciplineId === discipline.id);
                            const deleteAthletePromises = athletesToDelete.map(athlete => deleteDoc(doc(window.db, `artifacts/${window.appId}/public/data/athletes`, athlete.id)));
                            Promise.all(deleteAthletePromises)
                                .then(() => deleteDoc(doc(window.db, `artifacts/${window.appId}/public/data/disciplines`, discipline.id)))
                                .then(() => window.displayMessage('Disciplina y atletas asociados eliminados exitosamente.'))
                                .catch(e => { console.error("Error deleting discipline: ", e); window.displayMessage('Error al eliminar disciplina.', true); });
                        }
                    };
                });
            };

            const renderAdminAthletes = () => {
                const listDiv = document.getElementById('athletes-admin-list');
                const disciplineSelect = document.getElementById('new-athlete-discipline-select');
                listDiv.innerHTML = '';
                disciplineSelect.innerHTML = '';

                currentDisciplines.forEach(discipline => {
                    const option = document.createElement('option');
                    option.value = discipline.id;
                    option.textContent = discipline.name;
                    disciplineSelect.appendChild(option);
                });

                // Set default selected option for new athlete dropdown if available
                if (currentDisciplines.length > 0 && !disciplineSelect.value) {
                    disciplineSelect.value = currentDisciplines[0].id;
                }

                currentAthletes.forEach(athlete => {
                    const disciplineName = currentDisciplines.find(d => d.id === athlete.disciplineId)?.name || 'Desconocida';
                    const itemDiv = document.createElement('div');
                    itemDiv.className = "flex flex-col sm:flex-row items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-blue-100";
                    itemDiv.innerHTML = `
                        <span class="text-blue-800 font-medium flex-grow mb-2 sm:mb-0">${athlete.name} (${disciplineName})</span>
                        <div class="flex space-x-2">
                            <button class="edit-athlete-btn px-4 py-2 bg-blue-500 text-white rounded-lg shadow-sm hover:bg-blue-600 transition-colors duration-200 text-sm">Editar</button>
                            <button class="delete-athlete-btn px-4 py-2 bg-red-500 text-white rounded-lg shadow-sm hover:bg-red-600 transition-colors duration-200 text-sm">Eliminar</button>
                        </div>
                    `;
                    listDiv.appendChild(itemDiv);

                    itemDiv.querySelector('.edit-athlete-btn').onclick = () => {
                        const newName = prompt("Editar nombre del atleta:", athlete.name);
                        if (newName && newName.trim() !== '') {
                            const newDisciplineId = prompt("Editar ID de la disciplina (ej. para 'Club de Ajedrez' busca su ID en la consola):", athlete.disciplineId);
                            if (newDisciplineId && newDisciplineId.trim() !== '') {
                                updateDoc(doc(window.db, `artifacts/${window.appId}/public/data/athletes`, athlete.id), { name: newName.trim(), disciplineId: newDisciplineId.trim() })
                                    .then(() => window.displayMessage('Atleta actualizado exitosamente.'))
                                    .catch(e => { console.error("Error updating athlete: ", e); window.displayMessage('Error al actualizar atleta.', true); });
                            }
                        }
                    };
                    itemDiv.querySelector('.delete-athlete-btn').onclick = () => {
                        if (confirm('¿Está seguro de que desea eliminar este atleta?')) {
                            deleteDoc(doc(window.db, `artifacts/${window.appId}/public/data/athletes`, athlete.id))
                                .then(() => window.displayMessage('Atleta eliminado exitosamente.'))
                                .catch(e => { console.error("Error deleting athlete: ", e); window.displayMessage('Error al eliminar atleta.', true); });
                        }
                    };
                });
            };

            // Real-time listeners for admin panel
            onSnapshot(disciplinesCollectionRef, (snapshot) => {
                currentDisciplines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminDisciplines();
                renderAdminAthletes(); // Re-render athletes to update discipline names
            }, (err) => {
                console.error("Error fetching disciplines for admin:", err);
                window.displayMessage("Error al cargar disciplinas en el panel de administración.", true);
            });

            onSnapshot(athletesCollectionRef, (snapshot) => {
                currentAthletes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminAthletes();
            }, (err) => {
                console.error("Error fetching athletes for admin:", err);
                window.displayMessage("Error al cargar atletas en el panel de administración.", true);
            });

            // Add Discipline Button
            document.getElementById('add-discipline-btn').onclick = () => {
                const newDisciplineName = document.getElementById('new-discipline-name').value;
                if (newDisciplineName.trim() === '') {
                    window.displayMessage('El nombre de la disciplina no puede estar vacío.', true);
                    return;
                }
                addDoc(disciplinesCollectionRef, { name: newDisciplineName.trim() })
                    .then(() => {
                        document.getElementById('new-discipline-name').value = '';
                        window.displayMessage('Disciplina agregada exitosamente.');
                    })
                    .catch(e => { console.error("Error adding discipline: ", e); window.displayMessage('Error al agregar disciplina.', true); });
            };

            // Add Athlete Button
            document.getElementById('add-athlete-btn').onclick = () => {
                const newAthleteName = document.getElementById('new-athlete-name').value;
                const newAthleteDisciplineId = document.getElementById('new-athlete-discipline-select').value;
                if (newAthleteName.trim() === '' || newAthleteDisciplineId.trim() === '') {
                    window.displayMessage('El nombre del atleta y la disciplina no pueden estar vacíos.', true);
                    return;
                }
                addDoc(athletesCollectionRef, {
                    name: newAthleteName.trim(),
                    disciplineId: newAthleteDisciplineId,
                    questionnaireData: {}
                })
                .then(() => {
                    document.getElementById('new-athlete-name').value = '';
                    window.displayMessage('Atleta agregado exitosamente.');
                })
                .catch(e => { console.error("Error adding athlete: ", e); window.displayMessage('Error al agregar atleta.', true); });
            };
        }

        // Main render function to switch between views
        window.renderApp = () => {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            // Control visibility of "Ver Hoja de Cálculo" link
            const viewSheetLink = document.getElementById('view-sheet-link');
            if (viewSheetLink) {
                if (window.isAdmin) {
                    viewSheetLink.classList.remove('hidden');
                } else {
                    viewSheetLink.classList.add('hidden');
                }
            }

            // Control "Modo Admin" / "Salir Admin" button in footer
            const adminModeButton = document.getElementById('admin-mode-button');
            if (adminModeButton) {
                if (window.isAdmin) {
                    adminModeButton.textContent = 'Salir Admin';
                    adminModeButton.className = 'px-4 py-2 rounded-lg shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 bg-red-500 text-white hover:bg-red-600';
                    adminModeButton.onclick = () => {
                        window.isAdmin = false;
                        window.navigateTo('disciplines'); // Go back to disciplines view
                    };
                } else {
                    adminModeButton.textContent = 'Modo Admin';
                    adminModeButton.className = 'px-4 py-2 rounded-lg shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 bg-blue-400 text-white hover:bg-blue-500';
                    adminModeButton.onclick = () => window.openPasswordPrompt();
                }
            }


            if (window.isAdmin) {
                renderAdminPanel();
            } else {
                switch (window.currentView) {
                    case 'disciplines':
                        renderDisciplineList();
                        break;
                    case 'athletes':
                        renderAthleteList();
                        break;
                    case 'questionnaire':
                        renderQuestionnaire();
                        break;
                    default:
                        renderDisciplineList();
                }
            }
            // Update user ID in footer
            document.getElementById('user-id-display').textContent = `ID de Usuario: ${window.userId}`;
        };

        // Admin Password Prompt Modal Logic
        window.openPasswordPrompt = () => {
            window.showPasswordPrompt = true;
            document.getElementById('password-prompt-modal').classList.remove('hidden');
            document.getElementById('password-input').value = '';
            document.getElementById('password-error').textContent = '';
        };

        window.closePasswordPrompt = () => {
            window.showPasswordPrompt = false;
            document.getElementById('password-prompt-modal').classList.add('hidden');
            document.getElementById('password-input').value = '';
            document.getElementById('password-error').textContent = '';
        };

        window.handleAdminLogin = () => {
            const passwordInput = document.getElementById('password-input').value;
            const passwordErrorDiv = document.getElementById('password-error');
            if (passwordInput === window.ADMIN_PASSWORD) {
                window.isAdmin = true;
                window.closePasswordPrompt();
                window.renderApp(); // Re-render to admin panel
            } else {
                passwordErrorDiv.textContent = 'Contraseña incorrecta.';
            }
        };

        // Carousel Logic
        setInterval(() => {
            window.currentImageIndex = (window.currentImageIndex + 1) % window.backgroundImages.length;
            const backgroundContainer = document.getElementById('background-carousel');
            if (backgroundContainer) {
                backgroundContainer.innerHTML = ''; // Clear previous images
                window.backgroundImages.forEach((image, index) => {
                    const imgElement = document.createElement('img');
                    imgElement.src = image;
                    imgElement.alt = `Fondo UCV ${index + 1}`;
                    imgElement.className = `absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 ease-in-out ${
                        index === window.currentImageIndex ? 'opacity-20' : 'opacity-0'
                    }`;
                    backgroundContainer.appendChild(imgElement);
                });
            }
        }, 5000); // Change image every 5 seconds

    </script>
</head>
<body class="min-h-screen font-inter text-gray-800 relative">
    <div id="app" class="min-h-screen font-inter text-gray-800 relative overflow-auto">
        <!-- Background Carousel Images -->
        <div id="background-carousel" class="absolute inset-0 z-0">
            <!-- Images will be dynamically loaded here by JS -->
        </div>
        <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-blue-100 opacity-80 z-0"></div>

        <!-- Sticky Header -->
        <header class="sticky top-0 z-50 w-full bg-white bg-opacity-90 rounded-b-xl shadow-lg p-4 mb-4 sm:mb-8 flex flex-col sm:flex-row justify-between items-center border-b border-blue-200">
            <!-- DAIA Logo as Home Button (Left Side) -->
            <button
                onclick="navigateTo('disciplines')"
                class="rounded-full overflow-hidden shadow-md hover:opacity-80 transition-opacity duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 mb-4 sm:mb-0"
                title="Volver al Inicio"
            >
                <img
                    src="https://placehold.co/60x60/000080/FFFFFF?text=DAIA+Logo"
                    alt="Logo DAIA"
                    class="w-12 h-12 object-cover rounded-full"
                />
            </button>

            <h1 class="text-2xl sm:text-3xl font-bold text-blue-800 text-center flex-grow mb-4 sm:mb-0">
                Seguimiento Atletas UCV - Artículo 25
            </h1>
            <div class="flex items-center space-x-4">
                <a
                    id="view-sheet-link"
                    href="https://docs.google.com/spreadsheets/d/1aw2H5AQ5GQ_QT1UhG4jEDECKQAVXtbVw0t4eT-z91MY/edit#gid=0"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 hidden"
                >
                    Ver Hoja de Cálculo
                </a>
            </div>
        </header>

        <div class="relative z-10 p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">
            <main id="main-content" class="w-full max-w-4xl bg-white bg-opacity-95 rounded-xl shadow-2xl p-6 sm:p-8 border border-blue-300">
                <!-- Content will be rendered here by JavaScript -->
                <div class="text-center text-blue-700 text-xl font-semibold">Cargando aplicación...</div>
            </main>

            <footer class="w-full max-w-4xl text-center text-gray-600 mt-8 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <p id="user-id-display" class="text-sm">ID de Usuario: Cargando...</p>
                <p class="text-sm">Desarrollado para la Universidad Central de Venezuela</p>
                <button
                    id="admin-mode-button"
                    class="px-4 py-2 rounded-lg shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 bg-blue-400 text-white hover:bg-blue-500"
                >
                    Modo Admin
                </button>
            </footer>
        </div>

        <!-- Password Prompt Modal -->
        <div id="password-prompt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl border border-blue-300">
                <h3 class="text-xl font-semibold text-blue-800 mb-4">Ingresar Contraseña de Administrador</h3>
                <input
                    type="password"
                    id="password-input"
                    onkeypress="if(event.key === 'Enter') handleAdminLogin()"
                    class="w-full p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 mb-4"
                    placeholder="Contraseña"
                />
                <p id="password-error" class="text-red-500 text-sm mb-4"></p>
                <div class="flex justify-end space-x-4">
                    <button
                        onclick="closePasswordPrompt()"
                        class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200"
                    >
                        Cancelar
                    </button>
                    <button
                        onclick="handleAdminLogin()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200"
                    >
                        Ingresar
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
